name: Update README

on:
  push:
  schedule:
    # Run every Sunday at 6 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-dependents:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install github-dependents-info
      run: npm install -g github-dependents-info

    - name: Get dependents data
      id: dependents
      run: |
        # Get dependents data in JSON format
        github-dependents-info --repo pietrozullo/mcp-use --minstars 1 --sort stars --json > dependents.json

        # Extract total count and stars
        TOTAL_REPOS=$(jq -r '.total_dependents_number' dependents.json)
        PUBLIC_REPOS=$(jq -r '.public_dependents_number' dependents.json)
        TOTAL_STARS=$(jq -r '[.all_public_dependent_repos[].stars] | add' dependents.json)

        echo "total_repos=$TOTAL_REPOS" >> $GITHUB_OUTPUT
        echo "public_repos=$PUBLIC_REPOS" >> $GITHUB_OUTPUT
        echo "total_stars=$TOTAL_STARS" >> $GITHUB_OUTPUT

    - name: Update README with dependents
      run: |
        # Create the new dependents section
        cat > dependents_section.md << 'EOF'
        ## Top Starred Dependents

        Projects using mcp-use:

        | Repository | Stars |
        |------------|-------|
        EOF

        # Add top 8 repositories to the table
        jq -r '.all_public_dependent_repos[:8] | .[] | "| [\(.owner)/\(.repo_name)](https://github.com/\(.name)) | ⭐ \(.stars) |"' dependents.json >> dependents_section.md

        # Add summary and footer
        cat >> dependents_section.md << EOF

        **Total: ${{ steps.dependents.outputs.total_repos }} repositories using mcp-use** | **Public repositories: ${{ steps.dependents.outputs.public_repos }}** | **Combined stars: ${{ steps.dependents.outputs.total_stars }}**

        *This section is automatically updated weekly*
        EOF

        # Create a temporary file with the updated README
        awk '
        /^## Top Starred Dependents$/ {
          print "## Top Starred Dependents"
          print ""
          print "Projects using mcp-use:"
          print ""
          print "| Repository | Stars |"
          print "|------------|-------|"
          # Skip to the end of the current dependents section
          while (getline && !/^## Contributors$/) {
            if (/^\*This section is automatically updated weekly\*$/) {
              break
            }
          }
          # Insert the new dependents data
          while ((getline line < "dependents.json") > 0) {
            break
          }
          close("dependents.json")
          system("jq -r \".all_public_dependent_repos[:8] | .[] | \\\"| [\\(.owner)/\\(.repo_name)](https://github.com/\\(.name)) | ⭐ \\(.stars) |\\\"\" dependents.json")
          print ""
          print "**Total: ${{ steps.dependents.outputs.total_repos }} repositories using mcp-use** | **Public repositories: ${{ steps.dependents.outputs.public_repos }}** | **Combined stars: ${{ steps.dependents.outputs.total_stars }}** "
          print ""
          print "*This section is automatically updated weekly*"
          print ""
          print "## Contributors"
          next
        }
        { print }
        ' README.md > README_updated.md

        # Replace the original README
        mv README_updated.md README.md

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet README.md; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git commit -m "chore: update dependents list (automated)

        - Updated with ${{ steps.dependents.outputs.total_repos }} total repositories
        - Combined stars: ${{ steps.dependents.outputs.total_stars }}

        🤖 Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push

    - name: Clean up
      run: |
        rm -f dependents.json dependents_section.md

  contrib-readme-job:
    runs-on: ubuntu-latest
    name: A job to automate contrib in readme
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Contribute List
        uses: akhilmhdh/contributors-readme-action@v2.3.10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
