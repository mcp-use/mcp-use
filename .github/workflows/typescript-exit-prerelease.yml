name: TypeScript Exit Prerelease Mode

on:
  push:
    branches:
      - main
    paths:
      - "libraries/typescript/**"

jobs:
  create-exit-prerelease-pr:
    name: Create Exit Prerelease PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if in prerelease mode
        working-directory: libraries/typescript
        id: check
        run: |
          if [ -f .changeset/pre.json ]; then
            echo "in_prerelease=true" >> $GITHUB_OUTPUT
            echo "üê§ Detected prerelease mode on main branch"
          else
            echo "in_prerelease=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Not in prerelease mode - skipping"
          fi

      - name: Setup pnpm
        if: steps.check.outputs.in_prerelease == 'true'
        uses: pnpm/action-setup@v3
        with:
          version: 10.6.1

      - name: Setup Node.js
        if: steps.check.outputs.in_prerelease == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 23
          cache: "pnpm"
          cache-dependency-path: libraries/typescript/pnpm-lock.yaml

      - name: Install Dependencies
        if: steps.check.outputs.in_prerelease == 'true'
        working-directory: libraries/typescript
        run: pnpm install --no-frozen-lockfile

      - name: Create exit prerelease branch and PR
        if: steps.check.outputs.in_prerelease == 'true'
        working-directory: libraries/typescript
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create new branch
          BRANCH_NAME="exit-prerelease-$(date +%s)"
          git checkout -b "$BRANCH_NAME"

          # Exit prerelease mode
          echo "Exiting prerelease mode..."
          pnpm changeset pre exit

          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .changeset/pre.json
          git commit -m "chore: exit prerelease mode"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "chore: Exit prerelease mode and prepare stable release" \
            --body "This PR exits prerelease mode after merging canary changes.

          ## What happens when this PR is merged:

          1. ‚úÖ Prerelease mode will be exited
          2. ‚úÖ The TypeScript Release workflow will run
          3. ‚úÖ Packages will be versioned to stable versions (removing canary tags)
          4. ‚úÖ Stable versions will be published to npm

          **This PR was automatically created because canary was merged to main while in prerelease mode.**"

          echo "‚úÖ Created PR for exiting prerelease mode"
