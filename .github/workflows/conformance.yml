name: MCP Conformance Tests

on:
  workflow_dispatch:
    inputs:
      python_only:
        description: 'Run only Python conformance tests'
        type: boolean
        default: false
      typescript_only:
        description: 'Run only TypeScript conformance tests'
        type: boolean
        default: false
  push:
    branches:
      - main
      - canary
    paths:
      - 'libraries/python/mcp_use/server/**'
      - 'libraries/python/pyproject.toml'
      - 'libraries/typescript/packages/mcp-use/src/server/**'
      - 'libraries/typescript/packages/mcp-use/package.json'
      - 'libraries/python/tests/integration/servers_for_testing/conformance_server.py'
      - 'libraries/typescript/packages/mcp-use/examples/server/conformance/**'
      - '.github/workflows/conformance.yml'
  pull_request:
    branches:
      - main
      - canary
    paths:
      - 'libraries/python/mcp_use/server/**'
      - 'libraries/python/pyproject.toml'
      - 'libraries/typescript/packages/mcp-use/src/server/**'
      - 'libraries/typescript/packages/mcp-use/package.json'
      - 'libraries/python/tests/integration/servers_for_testing/conformance_server.py'
      - 'libraries/typescript/packages/mcp-use/examples/server/conformance/**'
      - '.github/workflows/conformance.yml'

jobs:
  conformance-python:
    name: Python Server Conformance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.typescript_only }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        working-directory: libraries/python
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Start Python conformance server
        working-directory: libraries/python
        run: |
          source .venv/bin/activate
          python tests/integration/servers_for_testing/conformance_server.py --transport streamable-http --port 8000 &
          sleep 5

      - name: Run conformance tests against Python server
        run: |
          npx @modelcontextprotocol/conformance server --url http://127.0.0.1:8000/mcp 2>&1 | tee python-conformance-results.txt
          # Extract pass/fail summary
          echo "## Python Server Conformance Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "(SUMMARY|âœ“|âœ—|Total:)" python-conformance-results.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Python conformance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-conformance-results
          path: |
            python-conformance-results.txt
            results/

  conformance-typescript:
    name: TypeScript Server Conformance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.python_only }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        working-directory: libraries/typescript
        run: pnpm install

      - name: Build mcp-use package
        working-directory: libraries/typescript/packages/mcp-use
        run: pnpm build

      - name: Install conformance server dependencies
        working-directory: libraries/typescript/packages/mcp-use/examples/server/conformance
        run: pnpm install

      - name: Start TypeScript conformance server
        working-directory: libraries/typescript/packages/mcp-use/examples/server/conformance
        run: |
          npx tsx src/server.ts &
          sleep 5

      - name: Run conformance tests against TypeScript server
        run: |
          npx @modelcontextprotocol/conformance server --url http://localhost:3000/mcp 2>&1 | tee typescript-conformance-results.txt
          # Extract pass/fail summary
          echo "## TypeScript Server Conformance Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "(SUMMARY|âœ“|âœ—|Total:)" typescript-conformance-results.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload TypeScript conformance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: typescript-conformance-results
          path: |
            typescript-conformance-results.txt
            results/

  conformance-summary:
    name: Conformance Summary
    runs-on: ubuntu-latest
    needs: [conformance-python, conformance-typescript]
    if: always() && !cancelled()
    permissions:
      pull-requests: write

    steps:
      - name: Download Python results
        uses: actions/download-artifact@v4
        with:
          name: python-conformance-results
          path: python-results
        continue-on-error: true

      - name: Download TypeScript results
        uses: actions/download-artifact@v4
        with:
          name: typescript-conformance-results
          path: typescript-results
        continue-on-error: true

      - name: Parse results and create comment
        id: parse-results
        run: |
          # Parse Python results
          PY_PASSED=0
          PY_FAILED=0
          PY_DETAILS=""
          if [ -f python-results/python-conformance-results.txt ]; then
            PY_PASSED=$(grep -c "âœ“" python-results/python-conformance-results.txt || echo "0")
            PY_FAILED=$(grep -c "âœ—" python-results/python-conformance-results.txt || echo "0")
            PY_DETAILS=$(grep -E "(âœ“|âœ—)" python-results/python-conformance-results.txt | head -50 || echo "No details")
          fi
          
          # Parse TypeScript results
          TS_PASSED=0
          TS_FAILED=0
          TS_DETAILS=""
          if [ -f typescript-results/typescript-conformance-results.txt ]; then
            TS_PASSED=$(grep -c "âœ“" typescript-results/typescript-conformance-results.txt || echo "0")
            TS_FAILED=$(grep -c "âœ—" typescript-results/typescript-conformance-results.txt || echo "0")
            TS_DETAILS=$(grep -E "(âœ“|âœ—)" typescript-results/typescript-conformance-results.txt | head -50 || echo "No details")
          fi
          
          # Calculate totals and pass rates
          PY_TOTAL=$((PY_PASSED + PY_FAILED))
          TS_TOTAL=$((TS_PASSED + TS_FAILED))
          
          if [ $PY_TOTAL -gt 0 ]; then
            PY_RATE=$(echo "scale=1; $PY_PASSED * 100 / $PY_TOTAL" | bc)
          else
            PY_RATE="N/A"
          fi
          
          if [ $TS_TOTAL -gt 0 ]; then
            TS_RATE=$(echo "scale=1; $TS_PASSED * 100 / $TS_TOTAL" | bc)
          else
            TS_RATE="N/A"
          fi
          
          # Save to environment
          echo "py_passed=$PY_PASSED" >> $GITHUB_OUTPUT
          echo "py_failed=$PY_FAILED" >> $GITHUB_OUTPUT
          echo "py_rate=$PY_RATE" >> $GITHUB_OUTPUT
          echo "ts_passed=$TS_PASSED" >> $GITHUB_OUTPUT
          echo "ts_failed=$TS_FAILED" >> $GITHUB_OUTPUT
          echo "ts_rate=$TS_RATE" >> $GITHUB_OUTPUT
          
          # Save details to files for multiline handling
          echo "$PY_DETAILS" > py_details.txt
          echo "$TS_DETAILS" > ts_details.txt

      - name: Generate summary
        run: |
          echo "# MCP Conformance Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Python Server" >> $GITHUB_STEP_SUMMARY
          if [ -f python-results/python-conformance-results.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E "(âœ“|âœ—|Total:)" python-results/python-conformance-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No results available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## TypeScript Server" >> $GITHUB_STEP_SUMMARY
          if [ -f typescript-results/typescript-conformance-results.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E "(âœ“|âœ—|Total:)" typescript-results/typescript-conformance-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No results available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Known Missing Features" >> $GITHUB_STEP_SUMMARY
          echo "The following conformance tests are expected to fail due to missing SDK features:" >> $GITHUB_STEP_SUMMARY
          echo "- \`tools-call-audio\` - Audio content type not implemented" >> $GITHUB_STEP_SUMMARY
          echo "- \`resources-subscribe/unsubscribe\` - Resource subscriptions not implemented" >> $GITHUB_STEP_SUMMARY
          echo "- \`completion-complete\` - Autocomplete not implemented" >> $GITHUB_STEP_SUMMARY
          echo "- \`tools-call-elicitation\` (TS only) - Elicitation not in TypeScript SDK" >> $GITHUB_STEP_SUMMARY
          echo "- \`elicitation-sep1034-defaults\` (TS only) - Elicitation not in TypeScript SDK" >> $GITHUB_STEP_SUMMARY

      - name: Post comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pyPassed = '${{ steps.parse-results.outputs.py_passed }}';
            const pyFailed = '${{ steps.parse-results.outputs.py_failed }}';
            const pyRate = '${{ steps.parse-results.outputs.py_rate }}';
            const tsPassed = '${{ steps.parse-results.outputs.ts_passed }}';
            const tsFailed = '${{ steps.parse-results.outputs.ts_failed }}';
            const tsRate = '${{ steps.parse-results.outputs.ts_rate }}';
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const fs = require('fs');
            let pyDetails = 'No results available';
            let tsDetails = 'No results available';
            
            try {
              pyDetails = fs.readFileSync('py_details.txt', 'utf8').trim() || 'No results available';
            } catch (e) {}
            
            try {
              tsDetails = fs.readFileSync('ts_details.txt', 'utf8').trim() || 'No results available';
            } catch (e) {}
            
            const body = `## ðŸ”¬ MCP Conformance Test Results
            
            **Commit:** \`${sha}\`
            
            | Server | Passed | Failed | Pass Rate |
            |--------|--------|--------|-----------|
            | Python | ${pyPassed} | ${pyFailed} | ${pyRate}% |
            | TypeScript | ${tsPassed} | ${tsFailed} | ${tsRate}% |
            
            <details>
            <summary>Python Server Details</summary>
            
            \`\`\`
            ${pyDetails}
            \`\`\`
            
            </details>
            
            <details>
            <summary>TypeScript Server Details</summary>
            
            \`\`\`
            ${tsDetails}
            \`\`\`
            
            </details>
            
            <details>
            <summary>Known Missing Features</summary>
            
            - \`tools-call-audio\` - Audio content type not implemented
            - \`resources-subscribe/unsubscribe\` - Resource subscriptions not implemented  
            - \`completion-complete\` - Autocomplete not implemented
            - \`tools-call-elicitation\` (TS only) - Elicitation not in TypeScript SDK
            - \`elicitation-sep1034-defaults\` (TS only) - Elicitation not in TypeScript SDK
            
            </details>
            
            [View full run details](${runUrl})
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

