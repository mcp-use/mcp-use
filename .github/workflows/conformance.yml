name: MCP Conformance Tests

on:
  workflow_dispatch:
    inputs:
      python_only:
        description: 'Run only Python conformance tests'
        type: boolean
        default: false
      typescript_only:
        description: 'Run only TypeScript conformance tests'
        type: boolean
        default: false
  push:
    branches:
      - main
      - canary
    paths:
      - 'libraries/python/mcp_use/server/**'
      - 'libraries/python/pyproject.toml'
      - 'libraries/typescript/packages/mcp-use/src/server/**'
      - 'libraries/typescript/packages/mcp-use/package.json'
      - 'libraries/python/tests/integration/servers_for_testing/conformance_server.py'
      - 'libraries/typescript/packages/mcp-use/examples/server/conformance/**'
      - '.github/workflows/conformance.yml'
  pull_request:
    branches:
      - main
      - canary
    paths:
      - 'libraries/python/mcp_use/server/**'
      - 'libraries/python/pyproject.toml'
      - 'libraries/typescript/packages/mcp-use/src/server/**'
      - 'libraries/typescript/packages/mcp-use/package.json'
      - 'libraries/python/tests/integration/servers_for_testing/conformance_server.py'
      - 'libraries/typescript/packages/mcp-use/examples/server/conformance/**'
      - '.github/workflows/conformance.yml'

jobs:
  conformance-python:
    name: Python Server Conformance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.typescript_only }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        working-directory: libraries/python
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Start Python conformance server
        working-directory: libraries/python
        run: |
          source .venv/bin/activate
          python tests/integration/servers_for_testing/conformance_server.py --transport streamable-http --port 8000 &
          sleep 5

      - name: Run conformance tests against Python server
        run: |
          npx @modelcontextprotocol/conformance server --url http://127.0.0.1:8000/mcp 2>&1 | tee python-conformance-results.txt
          # Extract pass/fail summary
          echo "## Python Server Conformance Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "(SUMMARY|‚úì|‚úó|Total:)" python-conformance-results.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Python conformance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-conformance-results
          path: |
            python-conformance-results.txt
            results/

  conformance-typescript:
    name: TypeScript Server Conformance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.python_only }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        working-directory: libraries/typescript
        run: pnpm install

      - name: Build mcp-use package
        working-directory: libraries/typescript/packages/mcp-use
        run: pnpm build

      - name: Install conformance server dependencies
        working-directory: libraries/typescript/packages/mcp-use/examples/server/conformance
        run: pnpm install

      - name: Start TypeScript conformance server
        working-directory: libraries/typescript/packages/mcp-use/examples/server/conformance
        run: |
          npx tsx src/server.ts &
          sleep 5

      - name: Run conformance tests against TypeScript server
        run: |
          npx @modelcontextprotocol/conformance server --url http://localhost:3000/mcp 2>&1 | tee typescript-conformance-results.txt
          # Extract pass/fail summary
          echo "## TypeScript Server Conformance Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "(SUMMARY|‚úì|‚úó|Total:)" typescript-conformance-results.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload TypeScript conformance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: typescript-conformance-results
          path: |
            typescript-conformance-results.txt
            results/

  conformance-summary:
    name: Conformance Summary
    runs-on: ubuntu-latest
    needs: [conformance-python, conformance-typescript]
    if: always() && !cancelled()
    permissions:
      pull-requests: write

    steps:
      - name: Download Python results
        uses: actions/download-artifact@v4
        with:
          name: python-conformance-results
          path: python-results
        continue-on-error: true

      - name: Download TypeScript results
        uses: actions/download-artifact@v4
        with:
          name: typescript-conformance-results
          path: typescript-results
        continue-on-error: true

      - name: Parse results to JSON
        id: parse-results
        run: |
          # Function to parse results file into JSON
          parse_results() {
            local file=$1
            local json="{"
            local passed=0
            local failed=0
            local tests=""
            
            if [ -f "$file" ]; then
              while IFS= read -r line; do
                if echo "$line" | grep -q "‚úì"; then
                  test_name=$(echo "$line" | sed 's/.*‚úì[[:space:]]*//' | sed 's/[[:space:]]*$//')
                  tests="${tests}\"${test_name}\":true,"
                  ((passed++))
                elif echo "$line" | grep -q "‚úó"; then
                  test_name=$(echo "$line" | sed 's/.*‚úó[[:space:]]*//' | sed 's/[[:space:]]*$//')
                  tests="${tests}\"${test_name}\":false,"
                  ((failed++))
                fi
              done < "$file"
            fi
            
            # Remove trailing comma
            tests="${tests%,}"
            
            local total=$((passed + failed))
            local rate="0"
            if [ $total -gt 0 ]; then
              rate=$(echo "scale=1; $passed * 100 / $total" | bc)
            fi
            
            echo "{\"passed\":$passed,\"failed\":$failed,\"rate\":\"$rate\",\"tests\":{$tests}}"
          }
          
          # Parse both result files
          PY_JSON=$(parse_results "python-results/python-conformance-results.txt")
          TS_JSON=$(parse_results "typescript-results/typescript-conformance-results.txt")
          
          # Save to files for multiline handling
          echo "$PY_JSON" > py_results.json
          echo "$TS_JSON" > ts_results.json

      - name: Generate summary
        run: |
          echo "# üî¨ MCP Conformance Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Python Server" >> $GITHUB_STEP_SUMMARY
          if [ -f python-results/python-conformance-results.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E "(‚úì|‚úó)" python-results/python-conformance-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No results available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## TypeScript Server" >> $GITHUB_STEP_SUMMARY
          if [ -f typescript-results/typescript-conformance-results.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E "(‚úì|‚úó)" typescript-results/typescript-conformance-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Load parsed results
            let pyResults = { passed: 0, failed: 0, rate: "N/A", tests: {} };
            let tsResults = { passed: 0, failed: 0, rate: "N/A", tests: {} };
            
            try {
              pyResults = JSON.parse(fs.readFileSync('py_results.json', 'utf8'));
            } catch (e) { console.log('No Python results:', e.message); }
            
            try {
              tsResults = JSON.parse(fs.readFileSync('ts_results.json', 'utf8'));
            } catch (e) { console.log('No TypeScript results:', e.message); }
            
            // Get all unique test names from both servers
            const allTests = [...new Set([
              ...Object.keys(pyResults.tests || {}),
              ...Object.keys(tsResults.tests || {})
            ])].sort();
            
            // Build the table header
            const testHeaders = allTests.map(t => t.replace(/-/g, ' ')).join(' | ');
            const headerSeparator = allTests.map(() => ':---:').join(' | ');
            
            // Build Python row
            const pyTestCells = allTests.map(test => {
              if (pyResults.tests[test] === true) return '‚úÖ';
              if (pyResults.tests[test] === false) return '‚ùå';
              return '‚ûñ';
            }).join(' | ');
            
            // Build TypeScript row
            const tsTestCells = allTests.map(test => {
              if (tsResults.tests[test] === true) return '‚úÖ';
              if (tsResults.tests[test] === false) return '‚ùå';
              return '‚ûñ';
            }).join(' | ');
            
            const body = [
              '## üî¨ MCP Conformance Test Results',
              '',
              `**Commit:** \`${sha}\``,
              '',
              `| Server | Overall | Pass | Fail | ${testHeaders} |`,
              `|--------|:-------:|:----:|:----:|${headerSeparator}|`,
              `| Python | ${pyResults.rate}% | ${pyResults.passed} | ${pyResults.failed} | ${pyTestCells} |`,
              `| TypeScript | ${tsResults.rate}% | ${tsResults.passed} | ${tsResults.failed} | ${tsTestCells} |`,
              '',
              `[View full run details](${runUrl})`
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

